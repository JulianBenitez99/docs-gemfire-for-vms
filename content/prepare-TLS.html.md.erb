---
title: Preparing for Transport Layer Security (TLS)
---

This topic describes how to provide an existing Certificate Authority (CA)
certificate to [BOSH CredHub](https://docs.pivotal.io/tiledev/credhub.html) and how to generate a new CA
certificate with BOSH CredHub, if you do not already have one.

<p class="note warning"><strong>WARNING</strong>: This procedure involves restarting all of the VMs in an existing <%=vars.app_runtime_full%> (<%=vars.app_runtime_abbr%>) deployment in order to propagate a CA certificate. The operation can take a long time to complete.</p>

## <a id='overview'></a> Overview

Enabling TLS provisions <%=vars.product_full%> service instances with a certificate,
so that apps, gfsh, and Pulse can establish encrypted connections
with the <%=vars.product_short%> service instance.

The certificate deployed on the <%=vars.product_short%> service instance is a
**server certificate**.
The server certificate is generated by **CredHub**, a component designed for centralized credential management in <%=vars.app_runtime_abbr%>.
CredHub is deployed on the same VM as the BOSH Director.

CredHub generates the server certificate using a **Certificate Authority (CA) certificate**.
The CA certificate must be provided to CredHub by the operator or generated by CredHub.

Apps use the CA certificate to authenticate components of <%=vars.product_short%> service instances.
Apps that communicate with <%=vars.product_short%> must have access to the CA certificate
in order to validate that the server certificate can be trusted.

<p class="note warning"><strong>WARNING</strong>: An operator must rotate the CA certificate if it expires or if it becomes compromised.
To rotate your CA certificate, see <a href="rotating-ca.html">Managing Certificates</a>.
Do not attempt to rotate a CA certificate on your own.
Contact <%=vars.support_link%> and perform the procedure with their assistance.</p>

## <a id="provide-generate-pcf"></a> Provide or Generate a CA Certificate

TLS authorization requires a credential generated by CredHub. You do not need to create a new User
Account and Authentication (UAA) client for CredHub specifically to support TLS, as long as a UAA
Client exists with `credhub.write` and `credhub.read` permissions. The client used in this section is one that
was created during the <%=vars.ops_manager%> installation process: the `ops_manager` client. 

Perform the following steps to log in to CredHub and provide or generate a CA certificate:

1. From the <%=vars.ops_manager%> VM, set the API target of the CredHub CLI to your CredHub server.
    <br><br>
    Run the following command:

    ```
    credhub api https://BOSH-DIRECTOR:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    ```
    <br>
    where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub api http<span>s:</span>//10.0.0.5:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    </pre>

1. Log in to CredHub.
    <br><br>
    Run the following command:

    ```
    credhub login --client-name=CLIENT-NAME --client-secret=CLIENT-SECRET
    ```
    <br>
    where `CLIENT-NAME` is the client name, usually `ops_manager` or a CredHub-specific UAA client of your own creation, and
    `CLIENT-SECRET` is the client secret which can be found under the Credentials tab of the <%=vars.ops_manager%> tile with the name `Bosh Commandline Credentials`.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub login \
        --client-name=ops_manager \
        --client-secret=abcdefghijklm123456789
    </pre>

1. Use the CredHub CLI to check whether a services CA certificate already is present.
<br><br>
    Enter the following command:
      <pre class="terminal">
      $ credhub get \
          --name="/services/tls_ca"
      </pre>
    If you already have a certificate at the `services/tls_ca` path, skip to step 5.

1. Use the CredHub CLI to generate a CA certificate or provide an existing one.
    <p class="note"><strong>Note</strong>: Your deployment may have multiple CA certificates.
       VMware recommends a dedicated CA certificate for services.</p>
    If you do not have a CA certificate, use the CredHub CLI to generate one.
      Enter the following command:
      <pre class="terminal">
      $ credhub generate \
        --name="/services/tls_ca" \
        --type="certificate" \
        --no-overwrite \
        --is-ca \
        --common-name="rootCA"
      </pre>
    If you have an existing CA certificate that you want to use, create a new file called `root.pem` with the contents of the certificate.
      Then enter the following command, specifying the path to `root.pem` and the private key for the certificate:
      <pre class="terminal">
      $ credhub set \
        --name="/services/tls_ca" \
        --type="certificate" \
        --certificate=./root.pem \
        --private=ERKSOSMFF...
      </pre>

1. Use the BOSH CLI v2 to extract the `certificate` portion from the CA certificate and print it.
    Enter the following command:
    <pre class="terminal">
    $ bosh interpolate <(credhub get --name=/services/tls_ca) \
        --path=/value/certificate
    </pre>
1. Record the output of the `bosh interpolate` command from step 5.

## <a id='add-ca-cert-bosh'></a> Add the CA Certificate to <%=vars.ops_manager%>

Add the CA certificate to <%=vars.ops_manager%> by adding it to the BOSH Director tile and the Tanzu Application Service tile.

### Add the CA certificate to the BOSH Director tile:

1. Navigate to the <%=vars.ops_manager%> **Installation Dashboard** and select the **Bosh Director** tile.
Click **Security**.

1. Paste the contents of the CA certificate into **Trusted Certificates**.
Append to existing Trusted Certificates, if there are already certificates listed.
![Security: Trusted Certificates](./images/security-pane-trusted-certs.png)

1. Include Tanzu Ops Manager Root CA in Trusted Certs<br /><br />
Checking this box will place the Tanzu Ops Manager Root CA into the trusted certificate field. The
Bosh Director will then place this CA into the trust store of every VM that it deploys.
![Security: Include Trusted](./images/security-pane-include-trusted.png)

1. Generate VM passwords or use single password for all VMs<br /><br />
Choose Generate passwords or Use default BOSH password, whichever suits your implementation.<br />
![Security: Generate VM passwords](./images/security-pane-generate-pw.png)

1. Click **Save**.

### Add the CA certificate to the Tanzu Application Service tile

1. The CA certificate must also be added for the Gorouter.
Navigate to the TAS tile's **Settings** tab.

1. Click on **Networking**. Add the CA certificate to the box labeled **Certificate Authorities Trusted by Gorouter**.<br />
  ![Networking: CA Gorouter](./images/tas-networking-ca-gorouter.png)

1. Scroll down and add the CA certificate to the box labeled **Certificate Authorities trusted by the HAProxy**.<br />
  ![Networking: CA HA Proxy](./images/tas-networking-ca-haproxy.png)

1. Click **Save**.

## Save Your Changes

1.  Return to the Installation Dashboard.
1.  Click **Review Pending Changes** (see [Reviewing Pending Product Changes](https://docs.pivotal.io/pivotalcf/customizing/review-pending-changes.html)).
1.  Click **Apply Changes**.

